<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pictionary Online</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; margin:0; display:flex; height:100vh; }
  #left { flex: 1 1 auto; display:flex; flex-direction:column; }
  #topbar { padding:10px; display:flex; gap:8px; align-items:center; border-bottom:1px solid #ddd; flex-wrap:wrap; }
  #canvasWrap { flex:1 1 auto; display:flex; align-items:center; justify-content:center; background:#f7f7f7; }
  #c { background:#fff; border:1px solid #ddd; touch-action:none; max-width:100%; height:auto; }
  #right { width:380px; border-left:1px solid #ddd; display:flex; flex-direction:column; }
  #chat { flex:1 1 auto; overflow:auto; padding:10px; background:#fff; }
  #entry { display:flex; gap:6px; padding:10px; border-top:1px solid #eee; }
  #entry input { flex:1 1 auto; padding:8px; }
  #role { font-weight:600; }
  .sys { color:#666; }
  .me { color:#0a0; }
  .err { color:#a00; }
  #sideTabs { display:flex; border-bottom:1px solid #eee; }
  #sideTabs button { flex:1; padding:8px; border:0; background:#f7f7f7; cursor:pointer; }
  #sideTabs button.active { background:#fff; font-weight:600; border-bottom:2px solid #000; }
  .panel { display:none; height:100%; }
  .panel.active { display:block; }
  #playersList div { padding:6px 10px; border-bottom:1px solid #f1f1f1; }
  .badge { font-size:12px; padding:1px 6px; border-radius:10px; background:#eee; margin-left:6px; }
  .badge.drawer { background:#ffe8a3; }
  .badge.admin { background:#a3d9ff; }
  #wordOptions { display:flex; gap:8px; margin-left: auto; }
  #wordOptions button { padding:4px 8px; }
  /* Tools */
  #tools { display:flex; gap:8px; align-items:center; margin-left:auto; }
  .swatch { width:20px; height:20px; border-radius:50%; border:1px solid #aaa; cursor:pointer; }
  .swatch.active { outline:2px solid black; }
  #eraserBtn.active { outline:2px solid black; }
</style>
</head>
<body>
  <div id="left">
    <div id="topbar">
      <label>Room:</label>
      <input id="room" placeholder="e.g. GAME01" size="10" />
      <label>Name:</label>
      <input id="name" placeholder="Your name" size="12" />
      <button id="joinBtn">Join</button>
      <span id="role"></span>

      <div id="wordOptions"></div>
      <span id="drawerWord" style="margin-left:12px;color:#a00;"></span>

      <!-- Drawer tools -->
      <div id="tools">
        <div id="palette">
          <span class="swatch" data-color="#111" style="background:#111"></span>
          <span class="swatch" data-color="#e53935" style="background:#e53935"></span>
          <span class="swatch" data-color="#1e88e5" style="background:#1e88e5"></span>
          <span class="swatch" data-color="#43a047" style="background:#43a047"></span>
          <span class="swatch" data-color="#fdd835" style="background:#fdd835"></span>
          <span class="swatch" data-color="#8e24aa" style="background:#8e24aa"></span>
          <span class="swatch" data-color="#fb8c00" style="background:#fb8c00"></span>
        </div>
        <label>Size <input type="range" id="size" min="2" max="24" value="4" /></label>
        <button id="eraserBtn">Eraser</button>
        <button id="clearBtn" disabled>Clear</button>
      </div>
    </div>

    <div id="canvasWrap">
      <canvas id="c" width="900" height="600"></canvas>
    </div>
  </div>

  <div id="right">
    <div id="sideTabs">
      <button id="tabChat" class="active">Chat</button>
      <button id="tabPlayers">Players</button>
      <button id="tabAdmin">Admin</button>
    </div>

    <div id="panelChat" class="panel active">
      <div id="chat"></div>
      <div id="entry">
        <input id="msg" placeholder="Type a guess or chat…" />
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <div id="panelPlayers" class="panel">
      <div id="playersList"></div>
    </div>

    <div id="panelAdmin" class="panel">
      <div style="padding:10px; display:flex; flex-direction:column; gap:10px;">
        <div><b>Admin Controls</b></div>
        <div>Mode:
          <button id="modeRandom">Random</button>
          <button id="modeChoice">Choice</button>
        </div>
        <div>Lock Room:
          <button id="lockRoom">Lock</button>
          <button id="unlockRoom">Unlock</button>
        </div>
        <div>Kick player:
          <input id="kickName" placeholder="Exact name" />
          <button id="kickBtn">Kick</button>
        </div>
        <div>Make admin:
          <input id="makeAdminName" placeholder="Exact name" />
          <button id="makeAdminBtn">Make Admin</button>
        </div>
        <div>Revoke admin:
          <input id="revokeAdminName" placeholder="Exact name" />
          <button id="revokeAdminBtn">Revoke Admin</button>
        </div>
      </div>
    </div>
  </div>

<script>
// Hard-wired WebSocket URL:
const WS_URL = "wss://pictionary-1-b76g.onrender.com/ws";

let ws = null;
let isDrawer = false;
let isAdmin = false;
let drawing = false;
let last = null;
let currentMode = "random";

// Tools state
let eraseMode = false;
let brushColor = "#111";
let brushSize = 4;

const chat = document.getElementById('chat');
const roleSpan = document.getElementById('role');
const drawerWord = document.getElementById('drawerWord');
const clearBtn = document.getElementById('clearBtn');
const input = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');
const joinBtn = document.getElementById('joinBtn');
const roomInp = document.getElementById('room');
const nameInp = document.getElementById('name');

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
ctx.lineJoin = 'round';
ctx.lineCap = 'round';

function log(text, cls='') {
  const p = document.createElement('div');
  if (cls) p.className = cls;
  p.textContent = text;
  chat.appendChild(p);
  chat.scrollTop = chat.scrollHeight;
}

function send(obj) {
  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify(obj));
  }
}

function setTypingEnabled(enabled, placeholder=''){
  input.disabled = !enabled;
  sendBtn.disabled = !enabled;
  if (placeholder) input.placeholder = placeholder;
}

function connect() {
  const server = WS_URL;
  const room = (roomInp.value.trim() || '').toUpperCase();
  const name = nameInp.value.trim() || 'Player';
  if (!server) return log('Server URL not configured.', 'err');

  // prevent duplicate joins from same tab
  if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
    try { ws.close(); } catch(e){}
  }

  ws = new WebSocket(server);
  joinBtn.disabled = true; roomInp.disabled = true; nameInp.disabled = true;

  ws.onopen = () => {
    log('Connected.', 'sys');
    send({type:'join', room, name});
  };
  ws.onclose = () => {
    log('Disconnected.', 'sys');
    joinBtn.disabled = false; roomInp.disabled = false; nameInp.disabled = false;
  };
  ws.onerror = () => log('WebSocket error (see console).', 'err');

  ws.onmessage = (evt) => {
    let data;
    try { data = JSON.parse(evt.data); } catch { return; }
    switch(data.type){
      case 'error': log('Error: ' + data.message, 'err'); break;
      case 'joined':
        // might be renamed by server to unique name
        if (data.you && data.you !== nameInp.value.trim()) {
          nameInp.value = data.you;
          log(`Your name is set to ${data.you}.`, 'sys');
        }
        log(`Joined room ${data.room} as ${data.you}.`, 'sys');
        break;
      case 'system': log(data.text, 'sys'); break;
      case 'waiting':
        roleSpan.textContent = 'Waiting for more players…';
        drawerWord.textContent = '';
        isDrawer = false;
        clearBtn.disabled = true;
        setTypingEnabled(true, 'Type a guess or chat…');
        break;
      case 'role':
        isDrawer = (data.role === 'drawer');
        roleSpan.textContent = isDrawer ? 'You are the DRAWER' : `Drawer: ${data.drawerName}`;
        drawerWord.textContent = '';
        clearBtn.disabled = !isDrawer;
        document.getElementById('wordOptions').innerHTML = '';
        if (isDrawer) {
          setTypingEnabled(false, 'Drawer cannot chat');
          input.value = '';
        } else {
          setTypingEnabled(true, 'Type a guess or chat…');
        }
        updateToolUI();
        break;
      case 'secret_word':
        if (isDrawer) drawerWord.textContent = 'Your word: ' + data.word;
        break;
      case 'word_options':
        if (isDrawer && Array.isArray(data.options)) {
          log('You are the drawer. Choose ONE word before drawing.', 'sys');
          const wrap = document.getElementById('wordOptions');
          wrap.innerHTML = '';
          data.options.forEach(w=>{
            const b = document.createElement('button');
            b.textContent = w;
            b.onclick = ()=> send({type:'pick_word', word:w});
            wrap.appendChild(b);
          });
        }
        break;
      case 'draw': drawRemote(data); break;
      case 'clear': clearCanvas(); break;
      case 'chat': log(`${data.from}: ${data.text}`); break;
      case 'feedback':
        if (data.result === 'incorrect') log('Your guess was incorrect.', 'sys');
        break;
      case 'correct':
        log(`${data.player} guessed correctly! Word was "${data.word}".`, 'me');
        document.getElementById('wordOptions').innerHTML = '';
        break;
      case 'players':
        renderPlayers(data.players || []);
        break;
      case 'room_settings':
        currentMode = data.mode || 'random';
        document.getElementById('modeRandom').disabled = (currentMode==='random') || !isAdmin;
        document.getElementById('modeChoice').disabled = (currentMode==='choice') || !isAdmin;
        break;
    }
  };
}

function renderPlayers(players){
  const list = document.getElementById('playersList');
  list.innerHTML = '';
  isAdmin = false;
  const myName = nameInp.value.trim();
  players.forEach(p=>{
    const row = document.createElement('div');
    row.textContent = p.name;
    if (p.drawer) { const b = document.createElement('span'); b.className='badge drawer'; b.textContent='drawer'; row.appendChild(b); }
    if (p.admin)  { const b = document.createElement('span'); b.className='badge admin';  b.textContent='admin';  row.appendChild(b);
      if (p.name === myName) isAdmin = true; }
    list.appendChild(row);
  });
  // gate admin controls
  document.querySelectorAll('#panelAdmin button, #panelAdmin input').forEach(el=>{
    if (el.id === 'tabAdmin') return;
    if (['modeRandom','modeChoice','lockRoom','unlockRoom','kickBtn','makeAdminBtn','revokeAdminBtn','kickName','makeAdminName','revokeAdminName'].includes(el.id)) {
      el.disabled = !isAdmin;
    }
  });
  updateToolUI();
}

function updateToolUI(){
  // Drawer tools only usable by drawer
  document.querySelectorAll('.swatch, #size, #eraserBtn, #clearBtn').forEach(el=>{
    el.disabled = !isDrawer;
  });
  // highlight active color / eraser
  document.querySelectorAll('.swatch').forEach(s=>{
    s.classList.toggle('active', s.dataset.color === brushColor && !eraseMode && isDrawer);
  });
  document.getElementById('eraserBtn').classList.toggle('active', eraseMode && isDrawer);
}

function clearCanvas(){
  ctx.globalCompositeOperation = 'source-over';
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function drawStroke(from, to, color, size, erase){
  ctx.save();
  ctx.lineWidth = size;
  if (erase) {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.strokeStyle = 'rgba(0,0,0,1)';
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = color || '#111';
  }
  ctx.beginPath();
  ctx.moveTo(from.x, from.y);
  ctx.lineTo(to.x, to.y);
  ctx.stroke();
  ctx.restore();
}

function drawDot(p, color, size, erase){
  ctx.save();
  if (erase) {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(p.x, p.y, size/2, 0, Math.PI*2);
    ctx.fill();
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = color || '#111';
    ctx.beginPath();
    ctx.arc(p.x, p.y, size/2, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.restore();
}

function drawRemote(d){
  const p = {x: d.x, y: d.y};
  const drag = !!d.drag;
  const color = d.color || '#111';
  const size = d.size || 4;
  const erase = !!d.erase;
  if (drag && last){
    drawStroke(last, p, color, size, erase);
    last = p;
  } else {
    drawDot(p, color, size, erase);
    last = p;
  }
}

// Canvas events
canvas.addEventListener('pointerdown', (e)=>{
  if (!isDrawer) return;
  drawing = true; last = null;
  const r = canvas.getBoundingClientRect();
  const pos = { x: e.clientX - r.left, y: e.clientY - r.top };
  drawDot(pos, brushColor, brushSize, eraseMode);
  send({type:'draw', x: pos.x, y: pos.y, drag:false, color: brushColor, size: brushSize, erase: eraseMode});
});
canvas.addEventListener('pointermove', (e)=>{
  if (!isDrawer || !drawing) return;
  const r = canvas.getBoundingClientRect();
  const pos = { x: e.clientX - r.left, y: e.clientY - r.top };
  if (last){
    drawStroke(last, pos, brushColor, brushSize, eraseMode);
  } else {
    drawDot(pos, brushColor, brushSize, eraseMode);
  }
  last = pos;
  send({type:'draw', x: pos.x, y: pos.y, drag:true, color: brushColor, size: brushSize, erase: eraseMode});
});
['pointerup','pointercancel','pointerleave'].forEach(evt=>{
  canvas.addEventListener(evt, ()=>{ drawing = false; last = null; });
});

// Tools UI
document.querySelectorAll('.swatch').forEach(s=>{
  s.addEventListener('click', ()=>{
    if (!isDrawer) return;
    eraseMode = false;
    brushColor = s.dataset.color;
    updateToolUI();
  });
});
document.getElementById('size').addEventListener('input', (e)=>{
  brushSize = parseInt(e.target.value || '4', 10);
});
document.getElementById('eraserBtn').onclick = ()=>{
  if (!isDrawer) return;
  eraseMode = !eraseMode;
  updateToolUI();
};

// Clear (instant local + server broadcast)
clearBtn.onclick = ()=>{
  if (!isDrawer) return;
  clearCanvas();
  send({type:'clear'});
};

// Chat/guess send
sendBtn.onclick = ()=>{
  const text = input.value.trim();
  if (!text) return;
  if (isDrawer) return;               // drawer cannot send anything
  send({type:'guess', text});
  input.value = '';
};
input.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter') sendBtn.click();
});

// Join + Tabs
joinBtn.onclick = ()=>connect();
document.getElementById('tabChat').onclick = ()=>switchTab('panelChat');
document.getElementById('tabPlayers').onclick = ()=>switchTab('panelPlayers');
document.getElementById('tabAdmin').onclick = ()=>switchTab('panelAdmin');
function switchTab(id){
  ['panelChat','panelPlayers','panelAdmin'].forEach(pid=>{
    document.getElementById(pid).classList.toggle('active', pid===id);
  });
  ['tabChat','tabPlayers','tabAdmin'].forEach(tid=>{
    const map = {tabChat:'panelChat', tabPlayers:'panelPlayers', tabAdmin:'panelAdmin'};
    document.getElementById(tid).classList.toggle('active', map[tid]===id);
  });
}

// Admin actions
document.getElementById('modeRandom').onclick = ()=> send({type:'admin', action:'mode', mode:'random'});
document.getElementById('modeChoice').onclick = ()=> send({type:'admin', action:'mode', mode:'choice'});
document.getElementById('lockRoom').onclick = ()=> send({type:'admin', action:'lock'});
document.getElementById('unlockRoom').onclick = ()=> send({type:'admin', action:'unlock'});
document.getElementById('kickBtn').onclick = ()=>{
  const n = document.getElementById('kickName').value.trim();
  if (n) send({type:'admin', action:'kick', name:n});
};
document.getElementById('makeAdminBtn').onclick = ()=>{
  const n = document.getElementById('makeAdminName').value.trim();
  if (n) send({type:'admin', action:'make_admin', name:n});
};
document.getElementById('revokeAdminBtn').onclick = ()=>{
  const n = document.getElementById('revokeAdminName').value.trim();
  if (n) send({type:'admin', action:'revoke_admin', name:n});
};

// Init canvas
clearCanvas();
</script>
</body>
</html>
